#!/bin/bash


function deploy () {
    sed -i "s/wheezy/jessie/" /etc/apt/sources.list
    export DEBIAN_FRONTEND=noninteractive
    apt-get update
    apt-get install -y --force-yes locales
    sed -i "s/# en_US.UTF-8 UTF-8/en_US.UTF-8 UTF-8/" /etc/locale.gen
    locale-gen
    apt-get install -y \
        libfuse2 \
        python3-pip \
        netcat-openbsd \
        ntpdate
    apt-get clean
    pip3 install https://github.com/glic3rinu/basefs/tarball/master#egg=basefs-dev
}


function run () {
    {
        basefs resources -l -n fdf5:5351:1dfd:0:2000::1 -r > /tmp/resources
    } &
    {
        basefs genkey
        basefs get test 10.228.207.204 -f || basefs get test 147.83.168.171 -f
        sleep 10
        mkdir -p /tmp/test
        echo '' > /tmp/output
        basefs run test -d -iface pub0 &>> /tmp/output
    } &
}


function collect () {
    offset=$(ntpdate -d fdf5:5351:1dfd:0:2000::1 | grep 'offset ' | awk {'print $2'}|head -n1)
    echo -n '' > /tmp/results
    grep -ah "COMPLETED " /tmp/output | while read line; do
        linedate=$(echo "$line" | awk {'print $1 " " $2'})
        linedate=$(date '+%s.%3N' -d "$linedate + $offset seconds")
        entryhash=$(echo "$line" | awk {'print $6'})
        echo "$linedate $entryhash" >> /tmp/results
    done
}


if [[ $1 == '-d' ]]; then
    deploy
elif [[ $1 == '-r' ]]; then
    run
elif [[ $1 == '-c' ]]; then
    collect
fi
